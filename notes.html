<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Ders Notları | ASÜ Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen">

    <nav class="bg-red-600 p-4 sticky top-0 z-50 shadow-md">
        <div class="container mx-auto flex justify-between items-center">
            <a href="index.html" class="font-bold text-2xl">ASÜ HUB</a>
            <div class="flex gap-4 items-center">
                <a href="index.html" class="font-bold hover:text-black">ANA SAYFA</a>
                <button onclick="openModal()" class="bg-white text-red-600 px-4 py-2 rounded font-bold hover:bg-gray-200">+ NOT YÜKLE</button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-8 grid grid-cols-4 gap-8">
        <div class="col-span-1 space-y-2">
            <h3 class="font-bold text-gray-400 mb-2">BÖLÜMLER</h3>
            <button onclick="filter('Tümü')" class="w-full text-left p-3 bg-gray-800 hover:bg-gray-700 border-l-4 border-red-600">Tümü</button>
            <button onclick="filter('Mühendislik')" class="w-full text-left p-3 bg-gray-800 hover:bg-gray-700">Mühendislik</button>
            <button onclick="filter('İİBF')" class="w-full text-left p-3 bg-gray-800 hover:bg-gray-700">İİBF</button>
            <button onclick="filter('Eğitim')" class="w-full text-left p-3 bg-gray-800 hover:bg-gray-700">Eğitim</button>
        </div>

        <div class="col-span-3">
            <h2 class="text-2xl font-bold mb-6 border-b border-gray-700 pb-2" id="catTitle">Tüm Notlar</h2>
            <div id="grid" class="grid grid-cols-3 gap-6">Yükleniyor...</div>
        </div>
    </div>

    <div id="modal" class="fixed inset-0 bg-black bg-opacity-80 hidden flex items-center justify-center">
        <div class="bg-gray-800 p-8 rounded w-96 border border-gray-600">
            <h2 class="text-xl font-bold mb-4">Not Yükle</h2>
            <form id="form" class="space-y-4">
                <input type="text" id="title" placeholder="Ders Adı" class="w-full bg-gray-700 p-2 text-white border border-gray-600" required>
                <select id="fac" class="w-full bg-gray-700 p-2 text-white border border-gray-600"><option>Mühendislik</option><option>İİBF</option><option>Eğitim</option></select>
                <input type="file" id="file" class="text-white" required>
                <div class="flex gap-2">
                    <button type="submit" class="flex-1 bg-red-600 py-2 font-bold">GÖNDER</button>
                    <button type="button" onclick="document.getElementById('modal').classList.add('hidden')" class="flex-1 bg-gray-600 py-2">İPTAL</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const SUPABASE_URL = "https://kmzbywrcspzwuznexcla.supabase.co";
        const SUPABASE_KEY = "sb_publishable_z2fcMIygDFlXaZD3z1CxbA_YkPXzxNt";
        const asuDb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let all = [];

        async function load() {
            const { data } = await asuDb.from('notes').select('*').eq('is_approved', true);
            if(data) { all = data; render(all); }
            const q = new URLSearchParams(window.location.search).get('q');
            if(q) render(all.filter(n=>n.title.toLowerCase().includes(q.toLowerCase())));
        }
        function render(notes) {
            document.getElementById('grid').innerHTML = notes.length ? notes.map(n => `
                <div class="bg-gray-800 p-4 rounded border-t-4 border-red-600 hover:bg-gray-750 transition">
                    <h3 class="font-bold text-lg mb-1">${n.title}</h3>
                    <p class="text-gray-400 text-sm mb-4">${n.faculty}</p>
                    <a href="${n.file_url}" target="_blank" class="block text-center bg-gray-700 hover:bg-gray-600 py-2 rounded font-bold text-sm">İNCELE</a>
                </div>
            `).join('') : '<p class="text-gray-500">Not yok.</p>';
        }
        function filter(c) { 
            document.getElementById('catTitle').innerText = c;
            render(c==='Tümü'?all:all.filter(n=>n.faculty===c)); 
        }
        function openModal() {
            if(!localStorage.getItem('userEmail')) return alert("Giriş yapmalısın!");
            document.getElementById('modal').classList.remove('hidden');
        }
        document.getElementById('form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const f = document.getElementById('file').files[0];
            const name = Date.now() + "_" + f.name.replace(/[^a-zA-Z0-9.]/g,'');
            const { error: ue } = await asuDb.storage.from('ders-notlari').upload(name, f);
            if(ue) return alert("Yükleme hatası");
            const { data: pu } = asuDb.storage.from('ders-notlari').getPublicUrl(name);
            await asuDb.from('notes').insert([{ title:document.getElementById('title').value, file_url:pu.publicUrl, faculty:document.getElementById('fac').value, uploader_email:localStorage.getItem('userEmail') }]);
            alert("Gönderildi! Onay bekliyor."); location.reload();
        });
        load();
    </script>
</body>
</html>
