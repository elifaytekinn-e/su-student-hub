<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASÜ Hub - Ders Notları</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: #333; }
        .navbar { background-color: #ffffff; box-shadow: 0 2px 10px rgba(0,0,0,0.05); padding: 15px 0; }
        .navbar-brand { font-weight: 700; font-size: 1.5rem; color: #0d2346; }
        .navbar-brand span { color: #dc3545; }
        .nav-link { color: #555; font-weight: 500; margin: 0 10px; }
        .nav-link:hover, .nav-link.active { color: #dc3545; }
        
        /* Kartlar */
        .note-card { background: #fff; border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 1px solid #eee; transition: all 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .note-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.08); }
        .note-title { font-weight: 700; color: #333; font-size: 1.1rem; }
        
        /* Yorum Bölümü */
        .comment-box { background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 10px; border-left: 4px solid #0d6efd; }
        
        .btn-upload-new { background-color: #dc3545; color: white; font-weight: 600; padding: 10px 25px; border-radius: 8px; border:none; }
        .btn-upload-new:hover { background-color: #bb2d3b; color: white; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="index.html"><i class="fa-solid fa-graduation-cap me-2"></i>ASÜ <span>HUB</span></a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"><span class="navbar-toggler-icon"></span></button>
            <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
                <ul class="navbar-nav align-items-center">
                    <li class="nav-item"><a class="nav-link" href="index.html">Ana Sayfa</a></li>
                    <li class="nav-item"><a class="nav-link active" href="notes.html">Ders Notları</a></li>
                    <li class="nav-item"><a class="nav-link" href="books.html">Sahaf</a></li>
                    <li class="nav-item"><a class="nav-link" href="faq.html">S.S.S</a></li>
                    <li class="nav-item ms-lg-3"><a href="profile.html" class="btn btn-outline-dark btn-sm px-3">Profilim</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="fw-bold text-dark">Ders Notları</h2>
            <button class="btn btn-upload-new" data-bs-toggle="modal" data-bs-target="#uploadModal">
                <i class="fa-solid fa-cloud-arrow-up me-2"></i>Not Yükle
            </button>
        </div>

        <div class="row">
            <div class="col-lg-3 mb-4">
                <div class="card border-0 shadow-sm p-3">
                    <h5 class="fw-bold mb-3">Filtrele</h5>
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">Fakülte</label>
                        <select class="form-select" id="filterFaculty" onchange="filterNotes()">
                            <option value="all">Tümü</option>
                            <option value="muhendislik">Mühendislik Fak.</option>
                            <option value="iibf">İktisadi İdari Bil. Fak.</option>
                            <option value="egitim">Eğitim Fak.</option>
                            <option value="fen">Fen Edebiyat Fak.</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="col-lg-9">
                <div id="loadingSpinner" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                </div>
                <div id="notesContainer"></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="uploadModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">Ücretsiz Not Paylaş</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="uploadForm">
                        <div class="mb-3"><label class="form-label">Başlık</label><input type="text" class="form-control" id="noteTitle" required placeholder="Örn: Fizik 1 Final Notları"></div>
                        <div class="row mb-3">
                            <div class="col"><label class="form-label">Fakülte</label>
                                <select class="form-select" id="noteFaculty">
                                    <option value="muhendislik">Mühendislik</option>
                                    <option value="iibf">İİBF</option>
                                    <option value="egitim">Eğitim</option>
                                    <option value="fen">Fen Ed.</option>
                                </select>
                            </div>
                            <div class="col"><label class="form-label">Bölüm</label><input type="text" class="form-control" id="noteDept" placeholder="Bölüm Adı"></div>
                        </div>
                        <div class="mb-3"><label class="form-label">Açıklama</label><textarea class="form-control" id="noteDesc" placeholder="İçerik hakkında kısa bilgi..."></textarea></div>
                        
                        <div class="mb-3"><label class="form-label">Dosya Seç</label><input type="file" class="form-control" id="noteFile" required></div>
                        <button type="submit" class="btn btn-primary w-100" id="btnSubmit">Paylaş</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="commentsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold" id="commentModalTitle">Not Detayları</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6 class="fw-bold border-bottom pb-2">Öğrenci Yorumları</h6>
                    <div id="commentsList" class="mb-4" style="max-height: 300px; overflow-y: auto;">
                        <p class="text-muted small">Henüz yorum yapılmamış.</p>
                    </div>

                    <h6 class="fw-bold">Yorum Yap & Puan Ver</h6>
                    <form id="commentForm">
                        <input type="hidden" id="currentNoteId">
                        <div class="mb-2">
                            <select class="form-select form-select-sm" id="commentStars" style="width: 150px;">
                                <option value="5">⭐⭐⭐⭐⭐ (5)</option>
                                <option value="4">⭐⭐⭐⭐ (4)</option>
                                <option value="3">⭐⭐⭐ (3)</option>
                                <option value="2">⭐⭐ (2)</option>
                                <option value="1">⭐ (1)</option>
                            </select>
                        </div>
                        <div class="mb-2">
                            <textarea class="form-control" id="commentText" rows="2" placeholder="Düşüncelerin..."></textarea>
                        </div>
                        <button type="submit" class="btn btn-sm btn-dark">Gönder</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- AYARLAR ---
        // Burayı kendi Supabase URL ve Key bilgilerinle doldurmayı unutma!
        const SUPABASE_URL = 'BURAYA_SUPABASE_URL_GELECEK';
        const SUPABASE_KEY = 'BURAYA_SUPABASE_KEY_GELECEK';
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- BAŞLANGIÇ ---
        document.addEventListener('DOMContentLoaded', fetchNotes);

        // 1. NOTLARI ÇEK
        async function fetchNotes() {
            const container = document.getElementById('notesContainer');
            const spinner = document.getElementById('loadingSpinner');
            
            const { data, error } = await supabase.from('notes').select('*').order('created_at', { ascending: false });

            spinner.style.display = 'none';

            if (error) {
                console.error(error);
                container.innerHTML = '<div class="alert alert-danger">Veriler yüklenemedi.</div>';
                return;
            }
            renderNotes(data);
        }

        // 2. LİSTELEME (Fiyat Kısmı Düzenlendi)
        function renderNotes(notes) {
            const container = document.getElementById('notesContainer');
            container.innerHTML = '';

            if (!notes || notes.length === 0) {
                container.innerHTML = '<div class="alert alert-light text-center border">Henüz not yok.</div>';
                return;
            }

            notes.forEach(note => {
                const html = `
                <div class="note-card">
                    <div class="d-flex justify-content-between">
                        <div class="flex-grow-1">
                            <h5 class="note-title">${note.title}</h5>
                            <p class="text-muted small mb-1">
                                <i class="fa-solid fa-building-columns me-1"></i>${note.faculty} | 
                                <i class="fa-solid fa-graduation-cap me-1"></i>${note.department || 'Bölüm Yok'}
                            </p>
                            <p class="small text-muted mb-2">${note.description || ''}</p>
                            <small class="text-secondary"><i class="fa-solid fa-user me-1"></i> ${note.uploader_name || 'Öğrenci'}</small>
                        </div>
                        <div class="text-end" style="min-width: 120px;">
                            <div class="mb-3">
                                <span class="badge bg-success" style="font-size: 0.9rem;">Ücretsiz</span>
                            </div>
                            <a href="${note.file_url}" target="_blank" class="btn btn-sm btn-outline-primary w-100 mb-2">
                                <i class="fa-solid fa-download me-1"></i> İndir
                            </a>
                            <button class="btn btn-sm btn-outline-secondary w-100" onclick="openComments(${note.id}, '${note.title}')">
                                <i class="fa-regular fa-comment me-1"></i> Yorumlar
                            </button>
                        </div>
                    </div>
                </div>`;
                container.innerHTML += html;
            });
        }

        // 3. NOT YÜKLE (Otomatik Fiyat: 0)
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnSubmit');
            btn.innerHTML = 'Yükleniyor...'; btn.disabled = true;

            const file = document.getElementById('noteFile').files[0];
            const fileName = `note_${Date.now()}_${file.name}`;

            try {
                // a) Dosyayı yükle
                const { data: storageData, error: storageError } = await supabase.storage.from('course_notes').upload(fileName, file);
                if (storageError) throw storageError;

                // b) Link al
                const { data: publicUrlData } = supabase.storage.from('course_notes').getPublicUrl(fileName);
                const publicURL = publicUrlData.publicUrl;

                // c) Veritabanına yaz (Price: 0 olarak sabitlendi)
                const { error: dbError } = await supabase.from('notes').insert([{
                    title: document.getElementById('noteTitle').value,
                    faculty: document.getElementById('noteFaculty').value,
                    department: document.getElementById('noteDept').value,
                    description: document.getElementById('noteDesc').value,
                    price: 0, // ÜCRETSİZ
                    file_url: publicURL,
                    uploader_name: 'Misafir Öğrenci'
                }]);

                if (dbError) throw dbError;

                alert('Not başarıyla yüklendi!');
                location.reload();
            } catch (err) {
                alert('Hata: ' + err.message);
            } finally {
                btn.innerHTML = 'Paylaş'; btn.disabled = false;
            }
        });

        // 4. YORUMLARI AÇ
        async function openComments(noteId, noteTitle) {
            document.getElementById('commentModalTitle').innerText = noteTitle + " - Yorumlar";
            document.getElementById('currentNoteId').value = noteId;
            const commentsList = document.getElementById('commentsList');
            commentsList.innerHTML = '<p class="text-muted small">Yükleniyor...</p>';
            
            const modal = new bootstrap.Modal(document.getElementById('commentsModal'));
            modal.show();

            const { data, error } = await supabase.from('comments').select('*').eq('note_id', noteId).order('created_at', {ascending: false});

            commentsList.innerHTML = '';
            if (data && data.length > 0) {
                data.forEach(c => {
                    let stars = '';
                    for(let i=0; i<c.stars; i++) stars += '<i class="fa-solid fa-star text-warning"></i>';
                    
                    commentsList.innerHTML += `
                        <div class="comment-box">
                            <div class="d-flex justify-content-between">
                                <span class="fw-bold small">${c.user_name || 'Anonim'}</span>
                                <span class="small">${stars}</span>
                            </div>
                            <p class="mb-0 small mt-1">${c.comment_text}</p>
                        </div>
                    `;
                });
            } else {
                commentsList.innerHTML = '<p class="text-muted small">İlk yorumu sen yap!</p>';
            }
        }

        // 5. YORUM GÖNDER
        document.getElementById('commentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const noteId = document.getElementById('currentNoteId').value;
            const text = document.getElementById('commentText').value;
            const stars = document.getElementById('commentStars').value;

            const { error } = await supabase.from('comments').insert([{
                note_id: noteId,
                comment_text: text,
                stars: stars,
                user_name: 'Bir Öğrenci'
            }]);

            if (!error) {
                alert('Yorum gönderildi!');
                location.reload(); 
            } else {
                alert('Hata: ' + error.message);
            }
        });

        // 6. FİLTRELEME
        async function filterNotes() {
            const faculty = document.getElementById('filterFaculty').value;
            const container = document.getElementById('notesContainer');
            container.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div></div>';

            let query = supabase.from('notes').select('*');
            if (faculty !== 'all') query = query.eq('faculty', faculty);

            const { data, error } = await query;
            if(!error) renderNotes(data);
        }
    </script>
</body>
</html>
