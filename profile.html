<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profilim | ASÜ Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>tailwind.config = { theme: { extend: { colors: { asuDark: '#0f172a', asuCard: '#1e293b', asuPurple: '#6366f1' } } } }</script>
    <style>.toast { animation: slideIn 0.3s ease-out forwards; } @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } } .toast.hide { opacity: 0; }</style>
</head>
<body class="bg-asuDark text-slate-200 min-h-screen flex flex-col">
    <div id="toast-container" class="fixed top-20 right-5 z-[99] flex flex-col gap-3"></div>
    <nav class="bg-asuCard border-b border-slate-700 p-4 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <a href="index.html" class="font-bold text-xl text-white flex items-center gap-2"><img src="asu_logo.png" class="h-8"> ASÜ HUB</a>
            <div class="hidden md:flex items-center gap-4 text-sm">
                <a href="index.html" class="hover:text-white">Ana Sayfa</a>
                <a href="faq.html" class="hover:text-white">S.S.S</a>
                <button onclick="logout()" class="bg-red-500/10 text-red-500 border border-red-500/50 px-4 py-1.5 rounded font-bold hover:bg-red-600 hover:text-white transition-all">Çıkış Yap</button>
            </div>
            <button class="md:hidden text-white text-2xl" onclick="document.getElementById('mobile-menu').classList.toggle('hidden')"><i class="fa-solid fa-bars"></i></button>
        </div>
        <div id="mobile-menu" class="hidden md:hidden bg-slate-800 p-4 space-y-3 mt-2"><a href="index.html" class="block text-white">Ana Sayfa</a><button onclick="logout()" class="block w-full text-left text-red-400 font-bold">Çıkış Yap</button></div>
    </nav>
    <div class="max-w-6xl mx-auto p-6 space-y-8 flex-1">
        <div class="bg-gradient-to-r from-slate-800 to-slate-900 border border-slate-700 p-8 rounded-2xl flex flex-col md:flex-row items-center gap-8 shadow-2xl relative overflow-hidden">
            <div class="absolute top-0 right-0 w-64 h-64 bg-asuPurple/10 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none"></div>
            <div class="relative"><div class="w-32 h-32 bg-indigo-600 rounded-full flex items-center justify-center text-4xl font-bold text-white border-4 border-slate-700 shadow-xl" id="avatarBig">..</div></div>
            <div class="text-center md:text-left flex-1 z-10">
                <h1 class="text-3xl font-bold text-white mb-1" id="displayNick">Yükleniyor...</h1>
                <p class="text-slate-400 mb-4 font-mono text-sm" id="displayEmail">...</p>
                <div class="flex flex-wrap justify-center md:justify-start gap-3"><span class="bg-slate-800 border border-slate-600 px-3 py-1 rounded-full text-xs text-slate-300"><i class="fa-solid fa-graduation-cap text-asuPurple mr-1"></i> <span id="displayDept">Bölüm Yok</span></span></div>
            </div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-1 space-y-6">
                <div class="bg-asuCard border border-slate-700 p-6 rounded-xl"><h3 class="font-bold text-white mb-4 border-b border-slate-700 pb-2">Profili Düzenle</h3><div class="space-y-4"><div><label class="text-xs text-slate-400">Nickname</label><input type="text" id="inputNick" class="w-full bg-slate-900 border border-slate-600 rounded p-2.5 text-white text-sm" placeholder="Örn: Mühendis06"></div><div><label class="text-xs text-slate-400">Bölümün</label><select id="inputDept" class="w-full bg-slate-900 border border-slate-600 rounded p-2.5 text-white text-sm"><option value="">Seçiniz...</option><option value="Mühendislik Fak.">Mühendislik Fak.</option><option value="İ.İ.B.F">İ.İ.B.F</option><option value="Eğitim Fak.">Eğitim Fak.</option></select></div><button onclick="saveProfile()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-bold text-sm transition-colors">Kaydet</button></div></div>
            </div>
            <div class="lg:col-span-2 space-y-6">
                <div class="bg-asuCard border border-slate-700 p-6 rounded-xl"><div class="flex justify-between items-center mb-4 border-b border-slate-700 pb-2"><h3 class="font-bold text-white">Paylaştığım Notlar</h3><span class="bg-slate-800 text-xs px-2 py-1 rounded text-slate-400" id="countNotes">0</span></div><div id="myNotesList" class="space-y-3 max-h-60 overflow-y-auto pr-2"><p class="text-slate-500 text-sm italic text-center py-4">Henüz not paylaşmadın.</p></div></div>
                <div class="bg-asuCard border border-slate-700 p-6 rounded-xl"><div class="flex justify-between items-center mb-4 border-b border-slate-700 pb-2"><h3 class="font-bold text-white">Satıştaki Kitaplarım</h3><span class="bg-slate-800 text-xs px-2 py-1 rounded text-slate-400" id="countBooks">0</span></div><div id="myBooksList" class="space-y-3 max-h-60 overflow-y-auto pr-2"><p class="text-slate-500 text-sm italic text-center py-4">Henüz kitap ilanı vermedin.</p></div></div>
            </div>
        </div>
    </div>
    <script>
        const SUPABASE_URL = "https://kmzbywrcspzwuznexcla.supabase.co";
        const SUPABASE_KEY = "sb_publishable_z2fcMIygDFlXaZD3z1CxbA_YkPXzxNt"; 
        const asuDb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const userEmail = localStorage.getItem('userEmail');
        function showToast(msg, type='success') { const t=document.createElement('div'); t.className=`toast ${type==='success'?'bg-green-600':'bg-red-600'} text-white px-6 py-3 rounded shadow flex gap-2`; t.innerText=msg; document.getElementById('toast-container').appendChild(t); setTimeout(()=>{t.classList.add('hide');setTimeout(()=>t.remove(),300)},3000); }
        window.onload = async () => {
            if(!userEmail) window.location.href = 'login.html';
            document.getElementById('displayEmail').innerText = userEmail; document.getElementById('avatarBig').innerText = userEmail.substring(0,2).toUpperCase();
            await loadProfileData(); await loadMyContent();
        };
        async function loadProfileData() {
            const { data } = await asuDb.from('profiles').select('*').eq('email', userEmail).single();
            if(data) {
                if(data.nickname) { document.getElementById('displayNick').innerText = data.nickname; document.getElementById('inputNick').value = data.nickname; } 
                else { document.getElementById('displayNick').innerText = userEmail.split('@')[0]; }
                if(data.department) { document.getElementById('displayDept').innerText = data.department; document.getElementById('inputDept').value = data.department; }
            }
        }
        async function saveProfile() {
            const nick = document.getElementById('inputNick').value; const dept = document.getElementById('inputDept').value;
            const { error } = await asuDb.from('profiles').upsert({ email: userEmail, nickname: nick, department: dept }, { onConflict: 'email' });
            if(error) showToast("Hata: " + error.message, 'error'); else { showToast("Profil güncellendi!", 'success'); setTimeout(() => location.reload(), 1500); }
        }
        async function loadMyContent() {
            const { data: notes } = await asuDb.from('notes').select('*').eq('uploader_email', userEmail);
            if(notes) document.getElementById('countNotes').innerText = notes.length;
            if(notes) document.getElementById('myNotesList').innerHTML = notes.map(n => `<div class="bg-slate-800 p-3 rounded-lg flex justify-between items-center group"><div class="truncate w-3/4"><span class="text-sm text-slate-300">${n.title}</span><span class="block text-[10px] ${n.is_approved ? 'text-green-500' : 'text-yellow-500'}">${n.is_approved ? 'Yayında' : 'Onay Bekliyor'}</span></div><button onclick="deleteItem('notes', ${n.id})" class="text-slate-500 hover:text-red-400 p-2"><i class="fa-solid fa-trash"></i></button></div>`).join('');
            
            const { data: books } = await asuDb.from('books').select('*').eq('seller_email', userEmail);
            if(books) document.getElementById('countBooks').innerText = books.length;
            if(books) document.getElementById('myBooksList').innerHTML = books.map(b => `<div class="bg-slate-800 p-3 rounded-lg flex justify-between items-center group"><div class="truncate w-3/4"><span class="text-sm text-slate-300">${b.title}</span><span class="block text-[10px] ${b.is_approved ? 'text-green-500' : 'text-yellow-500'}">${b.is_approved ? 'Yayında' : 'Onay Bekliyor'}</span></div><button onclick="deleteItem('books', ${b.id})" class="text-slate-500 hover:text-red-400 p-2"><i class="fa-solid fa-trash"></i></button></div>`).join('');
        }
        async function deleteItem(table, id) { if(confirm("Silmek istediğine emin misin?")) { await asuDb.from(table).delete().eq('id', id); location.reload(); } }
        function logout() { localStorage.clear(); window.location.href = 'index.html'; }
    </script>
</body>
</html>


