<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>ASÜ Sahaf</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>tailwind.config = { theme: { extend: { colors: { asuDark: '#0f172a', asuCard: '#1e293b', asuPurple: '#6366f1' } } } }</script>
    <style>.toast { animation: slideIn 0.3s ease-out forwards; } @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } } .toast.hide { opacity: 0; }</style>
</head>
<body class="bg-asuDark text-slate-200 min-h-screen flex flex-col">
    <div id="toast-container" class="fixed top-20 right-5 z-[99] flex flex-col gap-3"></div>
    <nav class="bg-asuCard border-b border-slate-700 p-4 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <a href="index.html" class="font-bold text-xl text-white flex items-center gap-2"><img src="asu_logo.png" class="h-8"> ASÜ SAHAF</a>
            <div class="hidden md:flex gap-4 items-center">
                <a href="index.html" class="hover:text-white text-sm">Ana Sayfa</a>
                <a href="faq.html" class="hover:text-white text-sm">S.S.S</a>
                <button onclick="openModal()" class="bg-green-600 text-white px-4 py-2 rounded text-sm font-bold">İlan Ver</button>
            </div>
            <button class="md:hidden text-white text-2xl" onclick="document.getElementById('mobile-menu').classList.toggle('hidden')"><i class="fa-solid fa-bars"></i></button>
        </div>
        <div id="mobile-menu" class="hidden md:hidden bg-slate-800 p-4 space-y-3 mt-2"><a href="index.html" class="block text-white">Ana Sayfa</a><a href="faq.html" class="block text-slate-300">S.S.S</a><button onclick="openModal()" class="text-green-500 font-bold">İlan Ver</button></div>
    </nav>
    <div class="max-w-7xl mx-auto p-6 grid grid-cols-1 md:grid-cols-4 gap-8 flex-1">
        <div class="md:col-span-1 space-y-2"><h3 class="font-bold text-white mb-4">Kategoriler</h3><button onclick="filterBooks('Tümü')" class="w-full text-left px-4 py-3 bg-slate-800 rounded text-white">Tüm İlanlar</button><button onclick="filterBooks('Satılık')" class="w-full text-left px-4 py-3 bg-slate-800 rounded text-slate-300">Satılık</button><button onclick="filterBooks('Bağış')" class="w-full text-left px-4 py-3 bg-slate-800 rounded text-slate-300">Bağış</button></div>
        <div class="md:col-span-3"><h2 class="text-2xl font-bold text-white mb-6"><span id="currentCategory">Vitrin</span> <span class="text-sm bg-slate-800 px-2 py-1 rounded" id="bookCount">0</span></h2><div id="booksGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">Yükleniyor...</div></div>
    </div>
    <div id="uploadModal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center z-[60] p-4">
        <div class="bg-asuCard border border-slate-700 p-6 rounded-xl w-full max-w-lg relative max-h-[90vh] overflow-y-auto">
            <button onclick="document.getElementById('uploadModal').classList.add('hidden')" class="absolute top-4 right-4 text-slate-400"><i class="fa-solid fa-xmark"></i></button>
            <h2 class="text-xl font-bold text-white mb-4">Yeni İlan</h2>
            <form id="sellForm" class="space-y-4">
                <input type="file" id="bookImg" class="text-slate-400 text-sm" required>
                <input type="text" id="bookTitle" placeholder="Kitap Adı" class="w-full bg-slate-900 border border-slate-600 rounded p-3 text-white" required>
                <select id="listingType" class="w-full bg-slate-900 border border-slate-600 rounded p-3 text-white" onchange="togglePrice(this.value)"><option value="Satılık">Satılık</option><option value="Bağış">Bağış</option></select>
                <input type="number" id="bookPrice" placeholder="Fiyat (TL)" class="w-full bg-slate-900 border border-slate-600 rounded p-3 text-white">
                <input type="tel" id="contact" placeholder="Tel: 5xxxxxxxxx" class="w-full bg-slate-900 border border-slate-600 rounded p-3 text-white" required>
                <button type="submit" id="submitBtn" class="w-full bg-green-600 text-white font-bold py-3 rounded">Yayınla</button>
            </form>
        </div>
    </div>
    <script>
        const SUPABASE_URL = "https://kmzbywrcspzwuznexcla.supabase.co";
        const SUPABASE_KEY = "sb_publishable_z2fcMIygDFlXaZD3z1CxbA_YkPXzxNt"; 
        const asuDb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const userEmail = localStorage.getItem('userEmail');
        let allBooks = [];
        function showToast(msg, type='success') { const t=document.createElement('div'); t.className=`toast ${type==='success'?'bg-green-600':'bg-red-600'} text-white px-6 py-3 rounded shadow flex gap-2`; t.innerText=msg; document.getElementById('toast-container').appendChild(t); setTimeout(()=>{t.classList.add('hide');setTimeout(()=>t.remove(),300)},3000); }
        function openModal() { if(!userEmail) return showToast("Giriş yap!",'error'); document.getElementById('uploadModal').classList.remove('hidden'); }
        function togglePrice(t) { const p=document.getElementById('bookPrice'); if(t==='Bağış'){p.value='';p.disabled=true;p.placeholder='Ücretsiz';}else{p.disabled=false;p.placeholder='Fiyat (TL)';} }
        async function fetchBooks() { 
            const { data } = await asuDb.from('books').select('*').eq('is_approved', true).order('created_at', { ascending: false }); 
            if(data) { allBooks = data; renderBooks(allBooks); } 
        }
        function renderBooks(books) {
            document.getElementById('bookCount').innerText = books.length;
            const grid = document.getElementById('booksGrid');
            if(!books.length) { grid.innerHTML='<p class="text-slate-500">İlan yok.</p>'; return; }
            grid.innerHTML = books.map(b => `<div class="bg-asuCard border border-slate-700 rounded-xl overflow-hidden hover:border-slate-500 transition-all"><img src="${b.image_url}" class="w-full h-48 object-cover"><div class="p-4"><h3 class="font-bold text-white truncate">${b.title}</h3><p class="text-xs text-slate-400 mb-2">${b.seller_email.split('@')[0]}</p><div class="flex justify-between items-center"><span class="font-bold text-white">${b.type==='Satılık'?b.price+' ₺':'Ücretsiz'}</span><a href="https://wa.me/90${b.contact.replace(/[^0-9]/g,'')}" target="_blank" class="bg-green-600 text-white px-3 py-1 rounded text-sm">WhatsApp</a></div></div></div>`).join('');
        }
        function filterBooks(c) { renderBooks(c==='Tümü'?allBooks:allBooks.filter(b=>b.type===c)); }
        document.getElementById('sellForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn=document.getElementById('submitBtn'); const file=document.getElementById('bookImg').files[0];
            btn.disabled=true; btn.innerText="Yükleniyor...";
            try {
                const fileName=Date.now()+"_"+file.name.replace(/[^a-zA-Z0-9.]/g,'');
                const {error:fe}=await asuDb.storage.from('kitap-fotolari').upload(fileName,file);
                if(fe)throw fe;
                const {data:pu}=asuDb.storage.from('kitap-fotolari').getPublicUrl(fileName);
                const {error:de}=await asuDb.from('books').insert([{ title:document.getElementById('bookTitle').value, price:document.getElementById('bookPrice').value||"0", contact:document.getElementById('contact').value, image_url:pu.publicUrl, seller_email:userEmail, type:document.getElementById('listingType').value }]);
                if(de)throw de;
                showToast("İlan gönderildi! Onay bekleniyor.",'success'); setTimeout(()=>location.reload(),2000);
            } catch(er){ showToast("Hata:"+er.message,'error'); btn.disabled=false; btn.innerText="Yayınla"; }
        });
        fetchBooks();
    </script>
</body>
</html>




