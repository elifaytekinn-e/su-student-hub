<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Sahaf | ASÜ Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen">

    <nav class="bg-red-600 p-4 sticky top-0 z-50 shadow-md">
        <div class="container mx-auto flex justify-between items-center">
            <a href="index.html" class="font-bold text-2xl">ASÜ SAHAF</a>
            <div class="flex gap-4 items-center">
                <a href="index.html" class="font-bold hover:text-black">ANA SAYFA</a>
                <button onclick="openModal()" class="bg-white text-red-600 px-4 py-2 rounded font-bold hover:bg-gray-200">+ İLAN VER</button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-8 grid grid-cols-4 gap-8">
        <div class="col-span-1 space-y-2">
            <h3 class="font-bold text-gray-400 mb-2">FİLTRE</h3>
            <button onclick="filter('Tümü')" class="w-full text-left p-3 bg-gray-800 hover:bg-gray-700 border-l-4 border-green-500">Tümü</button>
            <button onclick="filter('Satılık')" class="w-full text-left p-3 bg-gray-800 hover:bg-gray-700">Satılık</button>
            <button onclick="filter('Bağış')" class="w-full text-left p-3 bg-gray-800 hover:bg-gray-700">Bağış</button>
        </div>

        <div class="col-span-3">
            <h2 class="text-2xl font-bold mb-6 border-b border-gray-700 pb-2" id="catTitle">Vitrin</h2>
            <div id="grid" class="grid grid-cols-3 gap-6">Yükleniyor...</div>
        </div>
    </div>

    <div id="modal" class="fixed inset-0 bg-black bg-opacity-80 hidden flex items-center justify-center">
        <div class="bg-gray-800 p-8 rounded w-96 border border-gray-600">
            <h2 class="text-xl font-bold mb-4">Kitap Sat</h2>
            <form id="form" class="space-y-4">
                <input type="file" id="img" class="text-white" required>
                <input type="text" id="title" placeholder="Kitap Adı" class="w-full bg-gray-700 p-2 text-white border border-gray-600" required>
                <select id="type" class="w-full bg-gray-700 p-2 text-white border border-gray-600"><option>Satılık</option><option>Bağış</option></select>
                <input type="number" id="price" placeholder="Fiyat (TL)" class="w-full bg-gray-700 p-2 text-white border border-gray-600">
                <input type="text" id="contact" placeholder="Tel No" class="w-full bg-gray-700 p-2 text-white border border-gray-600" required>
                <div class="flex gap-2">
                    <button type="submit" class="flex-1 bg-green-600 py-2 font-bold">YAYINLA</button>
                    <button type="button" onclick="document.getElementById('modal').classList.add('hidden')" class="flex-1 bg-gray-600 py-2">İPTAL</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const SUPABASE_URL = "https://kmzbywrcspzwuznexcla.supabase.co";
        const SUPABASE_KEY = "sb_publishable_z2fcMIygDFlXaZD3z1CxbA_YkPXzxNt";
        const asuDb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let all = [];

        async function load() {
            const { data } = await asuDb.from('books').select('*').eq('is_approved', true);
            if(data) { all = data; render(all); }
        }
        function render(books) {
            document.getElementById('grid').innerHTML = books.length ? books.map(b => `
                <div class="bg-gray-800 rounded border border-gray-700 overflow-hidden">
                    <img src="${b.image_url}" class="w-full h-48 object-cover">
                    <div class="p-4">
                        <h3 class="font-bold text-lg truncate">${b.title}</h3>
                        <p class="text-gray-400 text-xs mb-2">${b.seller_email}</p>
                        <div class="flex justify-between items-center font-bold">
                            <span class="text-green-400">${b.type==='Satılık' ? b.price + ' TL' : 'ÜCRETSİZ'}</span>
                            <a href="https://wa.me/90${b.contact.replace(/[^0-9]/g,'')}" target="_blank" class="bg-green-600 px-3 py-1 rounded text-xs text-white">WHATSAPP</a>
                        </div>
                    </div>
                </div>
            `).join('') : '<p class="text-gray-500">İlan yok.</p>';
        }
        function filter(c) { render(c==='Tümü'?all:all.filter(b=>b.type===c)); }
        function openModal() {
            if(!localStorage.getItem('userEmail')) return alert("Giriş yapmalısın!");
            document.getElementById('modal').classList.remove('hidden');
        }
        document.getElementById('form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const f = document.getElementById('img').files[0];
            const name = Date.now() + "_" + f.name.replace(/[^a-zA-Z0-9.]/g,'');
            const { error: ue } = await asuDb.storage.from('kitap-fotolari').upload(name, f);
            if(ue) return alert("Yükleme hatası");
            const { data: pu } = asuDb.storage.from('kitap-fotolari').getPublicUrl(name);
            await asuDb.from('books').insert([{ title:document.getElementById('title').value, price:document.getElementById('price').value, contact:document.getElementById('contact').value, image_url:pu.publicUrl, type:document.getElementById('type').value, seller_email:localStorage.getItem('userEmail') }]);
            alert("İlan gönderildi! Onay bekliyor."); location.reload();
        });
        load();
    </script>
</body>
</html>
