<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASÜ Sahaf | Kitap & Paylaşım</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        tailwind.config = { theme: { extend: { colors: { asuDark: '#0f172a', asuCard: '#1e293b', asuPurple: '#6366f1' } } } }
    </script>
    <style>
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        .toast { animation: slideIn 0.3s ease-out forwards; }
        .toast.hide { animation: fadeOut 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-asuDark text-slate-200 min-h-screen flex flex-col">

    <div id="toast-container" class="fixed top-20 right-5 z-[99] flex flex-col gap-3"></div>

    <nav class="bg-asuCard border-b border-slate-700 p-4 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <a href="index.html" class="font-bold text-xl text-white flex items-center gap-2">
                <img src="asu_logo.png" class="h-8"> ASÜ <span class="text-asuPurple">SAHAF</span>
            </a>
            
            <div class="hidden md:flex gap-4 items-center">
                <a href="index.html" class="hover:text-white text-sm">Ana Sayfa</a>
                <a href="notes.html" class="hover:text-white text-sm">Ders Notları</a>
                <button onclick="openModal()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg shadow-green-900/20 transition-all">
                    <i class="fa-solid fa-plus mr-1"></i> İlan Ver
                </button>
            </div>

            <div class="md:hidden">
                <button onclick="document.getElementById('mobile-menu').classList.toggle('hidden')" class="text-white text-2xl focus:outline-none">
                    <i class="fa-solid fa-bars"></i>
                </button>
            </div>
        </div>

        <div id="mobile-menu" class="hidden md:hidden bg-slate-800 border-t border-slate-700 mt-4 -mx-4 px-4 py-4 space-y-3">
            <a href="index.html" class="block text-slate-300 hover:text-white">Ana Sayfa</a>
            <a href="notes.html" class="block text-slate-300 hover:text-white">Ders Notları</a>
            <button onclick="openModal()" class="w-full text-left text-green-500 font-bold">İlan Ver</button>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto p-6 grid grid-cols-1 md:grid-cols-4 gap-8 flex-1">
        <div class="md:col-span-1 space-y-2">
            <h3 class="font-bold text-white mb-4 px-2">Kategoriler</h3>
            <button onclick="filterBooks('Tümü')" class="w-full text-left px-4 py-3 rounded-lg bg-slate-800 hover:bg-slate-700 text-white border border-slate-700 transition-colors focus:ring-2 ring-asuPurple">Tüm İlanlar</button>
            <button onclick="filterBooks('Satılık')" class="w-full text-left px-4 py-3 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-300 border border-slate-700 transition-colors focus:ring-2 ring-asuPurple"><i class="fa-solid fa-tag mr-2 text-blue-400"></i> Satılık</button>
            <button onclick="filterBooks('Bağış')" class="w-full text-left px-4 py-3 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-300 border border-slate-700 transition-colors focus:ring-2 ring-asuPurple"><i class="fa-solid fa-gift mr-2 text-pink-400"></i> Ücretsiz / Bağış</button>
            <button onclick="filterBooks('Takas')" class="w-full text-left px-4 py-3 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-300 border border-slate-700 transition-colors focus:ring-2 ring-asuPurple"><i class="fa-solid fa-rotate mr-2 text-green-400"></i> Takaslık</button>
        </div>

        <div class="md:col-span-3">
            <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-2">
                <span id="currentCategory">Vitrin</span>
                <span class="text-sm bg-slate-800 text-slate-400 px-2 py-1 rounded" id="bookCount">0</span>
            </h2>
            <div id="booksGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                <p class="text-slate-500">Yükleniyor...</p>
            </div>
        </div>
    </div>

    <div id="uploadModal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center z-[60] p-4">
        <div class="bg-asuCard border border-slate-700 p-6 rounded-xl w-full max-w-lg relative max-h-[90vh] overflow-y-auto">
            <button onclick="document.getElementById('uploadModal').classList.add('hidden')" class="absolute top-4 right-4 text-slate-400 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            <h2 class="text-xl font-bold text-white mb-4">Yeni İlan</h2>
            <form id="sellForm" class="space-y-4">
                <div class="border-2 border-dashed border-slate-600 rounded-lg p-4 text-center cursor-pointer hover:border-asuPurple transition-colors relative h-32 flex flex-col items-center justify-center">
                    <input type="file" id="bookImg" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" required>
                    <i class="fa-solid fa-camera text-2xl text-slate-400 mb-2"></i>
                    <span id="fileName" class="text-xs text-slate-500">Fotoğraf Seç</span>
                </div>
                <input type="text" id="bookTitle" placeholder="Kitap Adı" class="w-full bg-slate-900 border border-slate-600 rounded p-3 text-white outline-none" required>
                <div class="grid grid-cols-2 gap-4">
                    <select id="listingType" class="w-full bg-slate-900 border border-slate-600 rounded p-3 text-white outline-none" onchange="togglePrice(this.value)">
                        <option value="Satılık">Satılık</option>
                        <option value="Bağış">Bağış (Ücretsiz)</option>
                        <option value="Takas">Takaslık</option>
                    </select>
                    <select id="bookCondition" class="w-full bg-slate-900 border border-slate-600 rounded p-3 text-white outline-none">
                        <option value="Yeni Gibi">Yeni Gibi</option>
                        <option value="Az Kullanılmış">Az Kullanılmış</option>
                        <option value="Yıpranmış">Yıpranmış</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <input type="number" id="bookPrice" placeholder="Fiyat (TL)" class="w-full bg-slate-900 border border-slate-600 rounded p-3 text-white outline-none">
                    <input type="tel" id="contact" placeholder="Tel: 5xxxxxxxxx" class="w-full bg-slate-900 border border-slate-600 rounded p-3 text-white outline-none" required>
                </div>
                <p class="text-xs text-yellow-500">* İlanınız onaylandıktan sonra yayınlanır.</p>
                <button type="submit" id="submitBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg shadow-lg">Yayınla</button>
            </form>
        </div>
    </div>

    <footer class="bg-asuCard border-t border-slate-800 py-6 mt-auto text-center">
        <p class="text-slate-500 text-xs">&copy; 2025 ASÜ Student Hub</p>
    </footer>

    <script>
        const SUPABASE_URL = "https://kmzbywrcspzwuznexcla.supabase.co";
        const SUPABASE_KEY = "sb_publishable_2mPJ390ssxg8euZ9hgmfFg_O5mPR1Fh"; 
        const asuDb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const userEmail = localStorage.getItem('userEmail');
        let allBooks = [];

        function showToast(msg, type='success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const bg = type==='success'?'bg-green-600':'bg-red-600';
            const icon = type==='success'?'<i class="fa-solid fa-check-circle"></i>':'<i class="fa-solid fa-circle-exclamation"></i>';
            toast.className = `toast ${bg} text-white px-6 py-3 rounded-lg shadow-xl flex items-center gap-3 border border-white/10 backdrop-blur-md`;
            toast.innerHTML = `${icon} <span class="font-medium text-sm">${msg}</span>`;
            container.appendChild(toast);
            setTimeout(() => { toast.classList.add('hide'); setTimeout(()=>toast.remove(),300); }, 3000);
        }

        function openModal() {
            if(!userEmail) return showToast("Giriş yapmalısın!", 'error');
            document.getElementById('uploadModal').classList.remove('hidden');
        }

        function togglePrice(type) {
            const p = document.getElementById('bookPrice');
            if(type === 'Bağış' || type === 'Takas') { p.value=''; p.disabled=true; p.placeholder= type==='Bağış'?'Ücretsiz':'Takas'; }
            else { p.disabled=false; p.placeholder='Fiyat (TL)'; }
        }

        document.getElementById('bookImg').addEventListener('change', function(){ if(this.files[0]) document.getElementById('fileName').innerText=this.files[0].name; });

        async function fetchBooks() {
            const { data, error } = await asuDb.from('books').select('*').eq('is_approved', true).order('created_at', { ascending: false });
            if(data) { allBooks = data; renderBooks(allBooks); }
        }

        function renderBooks(books) {
            document.getElementById('bookCount').innerText = books.length;
            const grid = document.getElementById('booksGrid');
            if(!books.length) { grid.innerHTML='<div class="col-span-3 text-center py-10 text-slate-500">Henüz onaylanmış ilan yok.</div>'; return; }

            grid.innerHTML = books.map(b => {
                let badge = b.type==='Bağış'?'bg-pink-600':(b.type==='Takas'?'bg-green-600':'bg-blue-600');
                let price = b.type==='Satılık'?`${b.price} ₺`:(b.type==='Bağış'?'Ücretsiz':'Takas');
                let cleanPhone = b.contact.replace(/[^0-9]/g, '');
                if(cleanPhone.startsWith('0')) cleanPhone = cleanPhone.substring(1);
                let waLink = `https://wa.me/90${cleanPhone}`;

                return `
                <div class="bg-asuCard border border-slate-700 rounded-xl overflow-hidden hover:border-slate-500 transition-all group flex flex-col">
                    <div class="h-48 bg-slate-800 relative">
                        <img src="${b.image_url}" class="w-full h-full object-cover">
                        <span class="absolute top-2 right-2 ${badge} text-white text-xs font-bold px-2 py-1 rounded shadow">${b.type||'Satılık'}</span>
                        <span class="absolute bottom-2 left-2 bg-black/60 text-white text-xs px-2 py-1 rounded"><i class="fa-solid fa-star-half-stroke text-yellow-400 mr-1"></i>${b.condition||'Belirtilmedi'}</span>
                    </div>
                    <div class="p-4 flex flex-col flex-1">
                        <h3 class="font-bold text-white truncate mb-1">${b.title}</h3>
                        <p class="text-xs text-slate-400 mb-4"><i class="fa-regular fa-user"></i> ${b.seller_email.split('@')[0]}</p>
                        <div class="mt-auto flex justify-between items-center">
                            <span class="font-bold text-white">${price}</span>
                            <a href="${waLink}" target="_blank" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded text-sm"><i class="fa-brands fa-whatsapp"></i> İletişim</a>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function filterBooks(cat) {
            document.getElementById('currentCategory').innerText = cat==='Tümü'?'Vitrin':cat+' İlanları';
            renderBooks(cat==='Tümü'?allBooks:allBooks.filter(b=>b.type===cat));
        }

        document.getElementById('sellForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn=document.getElementById('submitBtn'); const file=document.getElementById('bookImg').files[0];
            if(!file) return showToast("Fotoğraf seç!", 'error');
            btn.disabled=true; btn.innerText="Yükleniyor...";
            try {
                const fileName=Date.now()+"_"+file.name.replace(/[^a-zA-Z0-9.]/g,'');
                const {error:fe}=await asuDb.storage.from('kitap-fotolari').upload(fileName,file);
                if(fe)throw fe;
                const {data:pu}=asuDb.storage.from('kitap-fotolari').getPublicUrl(fileName);
                const {error:de}=await asuDb.from('books').insert([{ title: document.getElementById('bookTitle').value, price: document.getElementById('bookPrice').value||"0", contact: document.getElementById('contact').value, image_url: pu.publicUrl, seller_email: userEmail, type: document.getElementById('listingType').value, condition: document.getElementById('bookCondition').value }]);
                if(de)throw de;
                
                showToast("İlan gönderildi! Onay bekliyor.", 'success');
                setTimeout(() => location.reload(), 2000);
            } catch(er){ showToast("Hata:"+er.message, 'error'); btn.disabled=false; btn.innerText="Yayınla"; }
        });
        fetchBooks();
    </script>
</body>
</html>
